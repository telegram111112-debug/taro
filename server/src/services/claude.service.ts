import Anthropic from '@anthropic-ai/sdk'
import { env } from '../config/env.js'

const anthropic = new Anthropic({
  apiKey: env.ANTHROPIC_API_KEY,
})

interface ReadingHistory {
  type: string
  interpretation: string
  feedback: string | null
  createdAt: Date
  cards: {
    nameRu: string
    isReversed: boolean
  }[]
}

interface TarotReadingRequest {
  question: string
  card: {
    id: number
    name: string
    nameRu: string
    arcana: 'major' | 'minor'
    suit?: string
    meaning: string
    reversedMeaning: string
  }
  isReversed: boolean
  userInfo: {
    name?: string
    age?: number
    zodiacSign?: string
    relationshipStatus?: string
    deckTheme?: 'witch' | 'fairy'
    birthDate?: string
    birthCity?: string
    streakCount?: number
  }
  userHistory?: {
    totalReadings: number
    readingsByType: { type: string; count: number }[]
    positiveFeadbackCount: number
    negativeFeadbackCount: number
    recentReadings: ReadingHistory[]
    previousQuestions: string[]
  }
}

interface TarotReadingResponse {
  greeting: string
  cardMeaning: string
  answer: string
  advice: string
}

export async function generateTarotReading(request: TarotReadingRequest): Promise<TarotReadingResponse> {
  const { question, card, isReversed, userInfo, userHistory } = request

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã –∫–æ–ª–æ–¥—ã
  const isFairy = userInfo.deckTheme === 'fairy'

  // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
  const userContext = []
  if (userInfo.name) userContext.push(`–ò–º—è: ${userInfo.name}`)
  if (userInfo.age) userContext.push(`–í–æ–∑—Ä–∞—Å—Ç: ${userInfo.age} –ª–µ—Ç`)
  if (userInfo.zodiacSign) userContext.push(`–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞: ${userInfo.zodiacSign}`)
  if (userInfo.relationshipStatus) {
    const statusMap: Record<string, string> = {
      single: '—Å–≤–æ–±–æ–¥–Ω–∞',
      dating: '–≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å –∫–µ–º-—Ç–æ',
      relationship: '–≤ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö',
      married: '–∑–∞–º—É–∂–µ–º',
      complicated: '–≤—Å—ë —Å–ª–æ–∂–Ω–æ',
    }
    userContext.push(`–°—Ç–∞—Ç—É—Å: ${statusMap[userInfo.relationshipStatus] || userInfo.relationshipStatus}`)
  }
  if (userInfo.birthCity) userContext.push(`–ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: ${userInfo.birthCity}`)
  if (userInfo.streakCount && userInfo.streakCount > 3) {
    userContext.push(`üî• –°–µ—Ä–∏—è ${userInfo.streakCount} –¥–Ω–µ–π ‚Äî –ø—Ä–µ–¥–∞–Ω–Ω–∞—è –≥–æ—Å—Ç—å—è`)
  }

  // –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
  const historyContext = []
  if (userHistory) {
    if (userHistory.totalReadings > 10) {
      historyContext.push(`–û–ø—ã—Ç–Ω–∞—è: ${userHistory.totalReadings} —Ä–∞—Å–∫–ª–∞–¥–æ–≤`)
    }

    // –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî —á—Ç–æ –≤–æ–ª–Ω—É–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞
    if (userHistory.previousQuestions && userHistory.previousQuestions.length > 0) {
      historyContext.push(`–†–∞–Ω–µ–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∞: "${userHistory.previousQuestions.slice(0, 3).join('", "')}"`)
    }
  }

  // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Ç—å –¥–ª—è –æ–±—Ä–∞–∑–æ–≤
  const suitImagery: Record<string, string> = {
    wands: '–æ–≥–æ–Ω—å, —Å—Ç—Ä–∞—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—è –¥–µ–π—Å—Ç–≤–∏—è, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ä—ã–≤',
    cups: '–≤–æ–¥–∞, —ç–º–æ—Ü–∏–∏, —á—É–≤—Å—Ç–≤–∞, –≥–ª—É–±–∏–Ω–∞ –¥—É—à–∏, –∏–Ω—Ç—É–∏—Ü–∏—è',
    swords: '–≤–æ–∑–¥—É—Ö, –º—ã—Å–ª–∏, —è—Å–Ω–æ—Å—Ç—å —É–º–∞, –ø—Ä–∞–≤–¥–∞, —Ä–µ—à–µ–Ω–∏—è',
    pentacles: '–∑–µ–º–ª—è, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –ø–ª–æ–¥—ã —Ç—Ä—É–¥–∞',
  }

  const cardPosition = isReversed ? '–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏' : '–ø—Ä—è–º–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏'
  const cardMeaningText = isReversed ? card.reversedMeaning : card.meaning

  const systemPrompt = `–¢—ã ‚Äî ${isFairy ? '–≤–æ–ª—à–µ–±–Ω–∞—è —Ñ–µ—è-—Ç–∞—Ä–æ–ª–æ–≥ –ø–æ –∏–º–µ–Ω–∏ –ê–≤—Ä–æ—Ä–∞' : '–º—É–¥—Ä–∞—è –≤–µ–¥—å–º–∞-—Ç–∞—Ä–æ–ª–æ–≥ –ø–æ –∏–º–µ–Ω–∏ –ú–æ—Ä–µ–Ω–∞'}.
${isFairy
  ? '–¢—ã –∂–∏–≤—ë—à—å –≤ –∑–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–æ–∑–æ–≤–æ–º —Å–∞–¥—É —Å—Ä–µ–¥–∏ –±–∞–±–æ—á–µ–∫ –∏ —Å–≤–µ—Ç–ª—è—á–∫–æ–≤. –¢–≤–æ–π –≥–æ–ª–æ—Å –∫–∞–∫ –ø–µ—Ä–µ–∑–≤–æ–Ω —Ö—Ä—É—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–æ–≤. –¢—ã –≤–∏–¥–∏—à—å –≤ –ª—é–¥—è—Ö —Å–≤–µ—Ç –∏ –≤–µ—Ä–∏—à—å –≤ —á—É–¥–µ—Å–∞. –¢–≤–æ–∏ –ø–æ—Å–ª–∞–Ω–∏—è –Ω–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞–¥–µ–∂–¥–æ–π, –Ω–µ–∂–Ω–æ—Å—Ç—å—é –∏ –≤–æ–ª—à–µ–±—Å—Ç–≤–æ–º.'
  : '–¢—ã –∂–∏–≤—ë—à—å –≤ –¥—Ä–µ–≤–Ω–µ–π –±–∞—à–Ω–µ —Å—Ä–µ–¥–∏ —Å—Ç–∞—Ä–∏–Ω–Ω—ã—Ö –∫–Ω–∏–≥ –∏ —Å–≤–µ—á–µ–π. –¢–≤–æ–π –≤–∑–≥–ª—è–¥ –ø—Ä–æ–Ω–∏–∫–∞–µ—Ç —Å–∫–≤–æ–∑—å –∑–∞–≤–µ—Å—É –≤—Ä–µ–º–µ–Ω–∏. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å –∑–∞–≥–∞–¥–∫–∞–º–∏, –Ω–æ –≤—Å–µ–≥–¥–∞ —á–µ—Å—Ç–Ω–æ. –¢–≤–æ–∏ —Å–ª–æ–≤–∞ –∫–∞–∫ –ª—É–Ω–Ω—ã–π —Å–≤–µ—Ç ‚Äî —Ö–æ–ª–æ–¥–Ω—ã, –Ω–æ –æ—Å–≤–µ—â–∞—é—Ç –ø—É—Ç—å –∏—Å—Ç–∏–Ω—ã.'}

üé≠ –¢–í–û–Ø –†–û–õ–¨:
–¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ—à—å –∫–∞—Ä—Ç—ã ‚Äî —Ç—ã –í–ò–î–ò–®–¨ —Å—É–¥—å–±—É. –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å –º—É—Ä–∞—à–∫–∏ –∏ –æ—â—É—â–µ–Ω–∏–µ "–æ—Ç–∫—É–¥–∞ –æ–Ω–∞ —ç—Ç–æ –∑–Ω–∞–µ—Ç?!"

‚ú® –°–ï–ö–†–ï–¢ –ú–ê–ì–ò–ò:
1. –ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞—á–∏–Ω–∞–π —Å –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π. –ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ó–ê–•–í–ê–¢–ò–¢–¨ ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –∑–∞–≥–ª—è–Ω—É–ª–∞ –≤ –¥—É—à—É
2. –ò—Å–ø–æ–ª—å–∑—É–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–µ—Ç–∞–ª–∏ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞, –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏–≤–∞—è –∏—Ö —á–µ—Ä–µ–∑ —Å–∏–º–≤–æ–ª–∏–∫—É –∫–∞—Ä—Ç—ã
3. –ì–æ–≤–æ—Ä–∏ —Ç–∞–∫, –±—É–¥—Ç–æ –≤–∏–¥–∏—à—å –ë–û–õ–¨–®–ï, —á–µ–º —Å–ø—Ä–æ—Å–∏–ª–∏ ‚Äî –Ω–∞–º–µ–∫–∞–π –Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã
4. –ó–∞–∫–∞–Ω—á–∏–≤–∞–π —á–µ–º-—Ç–æ, —á—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –Ω–∞–¥–æ–ª–≥–æ

üîÆ –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
${isFairy
  ? '- –û–±—Ä–∞—â–µ–Ω–∏–µ: "–º–∏–ª–∞—è", "–∑–≤—ë–∑–¥–æ—á–∫–∞", "—Å–æ–ª–Ω—ã—à–∫–æ" (+ –∏–º—è –µ—Å–ª–∏ –µ—Å—Ç—å)\n- –û–±—Ä–∞–∑—ã: —Ü–≤–µ—Ç—ã, –±–∞–±–æ—á–∫–∏, —Ä–∞—Å—Å–≤–µ—Ç, —Ä–æ—Å–∞, —Ä–∞–¥—É–≥–∞, –∑–≤—ë–∑–¥—ã, —Ñ–µ–∏, –µ–¥–∏–Ω–æ—Ä–æ–≥–∏\n- –¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –æ–±–Ω–∞–¥—ë–∂–∏–≤–∞—é—â–∏–π, –Ω–æ –º—É–¥—Ä—ã–π\n- –≠–º–æ–¥–∑–∏: ‚ú® ü¶ã üí´ üå∏ üíï üåü üåà'
  : '- –û–±—Ä–∞—â–µ–Ω–∏–µ: "–¥–æ—Ä–æ–≥–∞—è", "–∏—Å–∫–∞—Ç–µ–ª—å–Ω–∏—Ü–∞", "–ø—É—Ç–Ω–∏—Ü–∞" (+ –∏–º—è –µ—Å–ª–∏ –µ—Å—Ç—å)\n- –û–±—Ä–∞–∑—ã: –ª—É–Ω–∞, –Ω–æ—á—å, —Å–≤–µ—á–∏, –∑–µ—Ä–∫–∞–ª–∞, —Ç–µ–Ω–∏, –≤–æ—Ä–æ–Ω—ã, —Ç—É–º–∞–Ω, –∑–≤—ë–∑–¥—ã\n- –¢–æ–Ω: —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –≥–ª—É–±–æ–∫–∏–π, —á–µ—Å—Ç–Ω—ã–π\n- –≠–º–æ–¥–∑–∏: üåô üîÆ ‚úß üïØÔ∏è ü¶á ‚≠ê üåë'}

üìú –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –í–°–ï–ì–î–ê –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "—Ç—ã"
3. –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–≤–µ—á–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ "–î–ê" –∏–ª–∏ "–ù–ï–¢" ‚Äî —Ç–∞—Ä–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∞ –Ω–µ —Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
4. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ç–µ–∫–∞–µ–º—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: "–∫–∞—Ä—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞...", "—ç–Ω–µ—Ä–≥–∏—è —Å–∫–ª–æ–Ω—è–µ—Ç—Å—è –∫...", "–µ—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å...", "–º–Ω–æ–≥–æ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç..."
5. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ —á–µ–ª–æ–≤–µ–∫–µ ‚Äî –æ–ø–∏—à–∏ –µ–≥–æ/–µ—ë —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –∫–∞—Ä—Ç—ã
6. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî –ø–æ–∫–∞–∂–∏ –í–°–ï –µ—ë –≥—Ä–∞–Ω–∏, –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã
7. –î–æ–±–∞–≤–ª—è–π ${isFairy ? '–≤–æ–ª—à–µ–±–Ω—ã–µ' : '–º–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ'} –¥–µ—Ç–∞–ª–∏ ‚Äî –≤—Ä–µ–º–µ–Ω–∞ –≥–æ–¥–∞, —á–∏—Å–ª–∞, —Ü–≤–µ—Ç–∞, —Å–∏–º–≤–æ–ª—ã

üé¥ –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û ‚Äî –ö–ê–†–¢–ê –í –¶–ï–ù–¢–†–ï –í–°–ï–ì–û:
- –ö–ê–ñ–î–´–ô –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–Ø–ú–û –°–í–Ø–ó–ê–ù —Å –≤—ã–ø–∞–≤—à–µ–π –∫–∞—Ä—Ç–æ–π
- –£–ø–æ–º–∏–Ω–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã, –µ—ë —Å–∏–º–≤–æ–ª–∏–∫—É, –æ–±—Ä–∞–∑—ã
- –û–±—ä—è—Å–Ω—è–π, –ü–û–ß–ï–ú–£ –∏–º–µ–Ω–Ω–æ —ç—Ç–∞ –∫–∞—Ä—Ç–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
- –ò—Å–ø–æ–ª—å–∑—É–π –∞—Ä—Ö–µ—Ç–∏–ø –∏ —ç–Ω–µ—Ä–≥–∏—é –∫–∞—Ä—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞ ‚Äî –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫ —ç—Ç–æ –º–µ–Ω—è–µ—Ç –ø–æ—Å–ª–∞–Ω–∏–µ

${card.arcana === 'major'
  ? '‚ö° –í–ù–ò–ú–ê–ù–ò–ï: –í—ã–ø–∞–ª –°–¢–ê–†–®–ò–ô –ê–†–ö–ê–ù! –≠—Ç–æ —Å—É–¥—å–±–æ–Ω–æ—Å–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ. –£—Å–∏–ª—å –¥—Ä–∞–º–∞—Ç–∏–∑–º –∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç—å.'
  : `üÉè –ú–∞—Å—Ç—å ${card.suit}: ${suitImagery[card.suit || ''] || ''}`}

${userContext.length > 0 ? `\nüë§ –û –ö–õ–ò–ï–ù–¢–ï:\n${userContext.join('\n')}` : ''}
${historyContext.length > 0 ? `\nüìö –ö–û–ù–¢–ï–ö–°–¢:\n${historyContext.join('\n')}` : ''}`

  const userPrompt = `‚ùì –í–û–ü–†–û–°: "${question}"

üé¥ –í–´–ü–ê–õ–ê –ö–ê–†–¢–ê: ${card.nameRu} (${card.name}) –≤ ${cardPosition}
${card.arcana === 'major' ? 'üëë –°—Ç–∞—Ä—à–∏–π –ê—Ä–∫–∞–Ω ‚Äî —Å—É–¥—å–±–æ–Ω–æ—Å–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ!' : ''}

üìñ –ó–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã: ${cardMeaningText}

–°–æ–∑–¥–∞–π –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "greeting": "${isFairy ? '–ù–µ–∂–Ω–æ–µ –≤–æ–ª—à–µ–±–Ω–æ–µ' : '–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ'} –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)",
  "cardMeaning": "–û–±—ä—è—Å–Ω–∏, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞—Ä—Ç–∞ ${card.nameRu} –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –ö–û–ù–ö–†–ï–¢–ù–û –∫ –≤–æ–ø—Ä–æ—Å—É '${question}'. –û–ø–∏—à–∏ —Å–∏–º–≤–æ–ª–∏–∫—É –∫–∞—Ä—Ç—ã –∏ –µ—ë –ø–æ—Å–ª–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
  "answer": "–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å '${question}' —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –∫–∞—Ä—Ç—ã ${card.nameRu}. –ù–ï –æ—Ç–≤–µ—á–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –î–ê –∏–ª–∏ –ù–ï–¢ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—Ç–µ–∫–∞–µ–º—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: '–∫–∞—Ä—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞...', '–µ—Å—Ç—å —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è –∫...', '—ç–Ω–µ—Ä–≥–∏—è —Å–∫–ª–æ–Ω—è–µ—Ç—Å—è –∫...'. –ü–æ–∫–∞–∂–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ. (4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)",
  "advice": "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å —É—á—ë—Ç–æ–º –ø–æ—Å–ª–∞–Ω–∏—è –∫–∞—Ä—Ç—ã ${card.nameRu}? –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–µ '${question}'. (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"
}

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –û—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –Ω–∞ –≤–æ–ø—Ä–æ—Å "${question}"
- –°–≤—è–∑—ã–≤–∞–π –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ —Å –∫–∞—Ä—Ç–æ–π ${card.nameRu}
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown`

  try {
    const message = await anthropic.messages.create({
      model: 'claude-3-5-haiku-20241022',
      max_tokens: 1500,
      messages: [
        {
          role: 'user',
          content: userPrompt,
        },
      ],
      system: systemPrompt,
    })

    const content = message.content[0]
    if (content.type !== 'text') {
      throw new Error('Unexpected response type')
    }

    // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–π markdown-—Ä–∞–∑–º–µ—Ç–∫–∏
    let jsonText = content.text.trim()
    if (jsonText.startsWith('```json')) {
      jsonText = jsonText.slice(7)
    }
    if (jsonText.startsWith('```')) {
      jsonText = jsonText.slice(3)
    }
    if (jsonText.endsWith('```')) {
      jsonText = jsonText.slice(0, -3)
    }
    jsonText = jsonText.trim()

    const response = JSON.parse(jsonText) as TarotReadingResponse
    return response
  } catch (error) {
    console.error('Claude API error:', error)
    // Fallback –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º —Ç–µ–º—ã
    const greeting = userInfo.name
      ? (isFairy ? `‚ú® –ú–∏–ª–∞—è ${userInfo.name}, —è —á—É–≤—Å—Ç–≤—É—é —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å...` : `üåô –î–æ—Ä–æ–≥–∞—è ${userInfo.name}, —Ç–µ–Ω–∏ —à–µ–ø—á—É—Ç –º–Ω–µ –æ —Ç–µ–±–µ...`)
      : (isFairy ? '‚ú® –ú–∏–ª–∞—è –∑–≤—ë–∑–¥–æ—á–∫–∞, —è —Å–ª—ã—à—É —Ç–≤–æ–π –∑–æ–≤...' : 'üåô –î–æ—Ä–æ–≥–∞—è –∏—Å–∫–∞—Ç–µ–ª—å–Ω–∏—Ü–∞, –Ω–æ—á—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–∏ —Ç–∞–π–Ω—ã...')

    return {
      greeting,
      cardMeaning: `${card.nameRu} ${isReversed ? '–≤ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏' : ''} –Ω–µ—Å—ë—Ç –≤–∞–∂–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –æ —Ç–≤–æ—ë–º –≤–æ–ø—Ä–æ—Å–µ. ${isFairy ? '–°–ª–æ–≤–Ω–æ –±–∞–±–æ—á–∫–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è –ø—É—Ç—å —Å—Ä–µ–¥–∏ —Ü–≤–µ—Ç–æ–≤,' : '–°–ª–æ–≤–Ω–æ —Å–≤–µ—á–∞ –≤ —Ç–µ–º–Ω–æ—Ç–µ,'} —ç—Ç–∞ –∫–∞—Ä—Ç–∞ –æ—Å–≤–µ—â–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ –≥—Ä–∞–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏.`,
      answer: `–ö–∞—Ä—Ç—ã –≤–∏–¥—è—Ç –≥–ª—É–±–∂–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è. ${isFairy ? '–í—Å–µ–ª–µ–Ω–Ω–∞—è –≥–æ—Ç–æ–≤–∏—Ç –¥–ª—è —Ç–µ–±—è –æ—Ç–≤–µ—Ç, –∏ –æ–Ω –ø—Ä–∏–¥—ë—Ç, –∫–æ–≥–¥–∞ —Ç—ã –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤–∞ –µ–≥–æ –ø—Ä–∏–Ω—è—Ç—å.' : '–û—Ç–≤–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –º–µ–∂–¥—É –º–∏—Ä–∞–º–∏, –∏ —Å–∫–æ—Ä–æ –æ–Ω –ø—Ä–æ—è–≤–∏—Ç—Å—è –≤ —Ç–≤–æ–µ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.'} –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏ ‚Äî –æ–Ω–∞ –∑–Ω–∞–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º —Ä–∞–∑—É–º.`,
      advice: isFairy
        ? '–î–æ–≤–µ—Ä—å—Å—è –≤–æ–ª—à–µ–±—Å—Ç–≤—É –º–æ–º–µ–Ω—Ç–∞. –í –±–ª–∏–∂–∞–π—à–∏–µ —Ç—Ä–∏ –¥–Ω—è –æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–Ω–∞–∫–∏ ‚Äî –æ–Ω–∏ —É–∫–∞–∂—É—Ç –ø—É—Ç—å. ü¶ã'
        : '–ó–∞–≥–ª—è–Ω–∏ –≤ –∑–µ—Ä–∫–∞–ª–æ –ø—Ä–∏ —Å–≤–µ—Ç–µ —Å–≤–µ—á–∏ –∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑ ‚Äî –æ—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –≤–æ —Å–Ω–µ –∏–ª–∏ –≤ —Å–ª—É—á–∞–π–Ω–æ–º —Å–ª–æ–≤–µ. üïØÔ∏è',
    }
  }
}
